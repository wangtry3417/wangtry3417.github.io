<!DOCTYPE html>
<html>
<head>
    <title>Apple Pay æµ‹è¯•</title>
</head>
<body>
    <h2>Apple Pay æµ‹è¯•é¡µé¢</h2>
    
    <div id="status"></div>
    <button id="applePayBtn" style="display:none; padding:15px; background:black; color:white;">
        ğŸ ä½¿ç”¨ Apple Pay æ”¯ä»˜
    </button>
    
    <div id="result" style="margin-top:20px;"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const applePayBtn = document.getElementById('applePayBtn');
        
        // 1. æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const isSecure = window.location.protocol === 'https:' || 
                            window.location.hostname === 'localhost' ||
                            window.location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                statusDiv.innerHTML = `
                    <div style="background:#fff3cd; padding:15px; border:1px solid #ffeaa7;">
                        <h3>âš ï¸ ç¯å¢ƒè­¦å‘Š</h3>
                        <p>å½“å‰ä¸æ˜¯ HTTPS ç¯å¢ƒï¼ŒApple Pay å¯èƒ½æ— æ³•å·¥ä½œ</p>
                        <p>å»ºè®®è®¿é—®ï¼š<a href="https://localhost:3000">https://localhost:3000</a></p>
                    </div>
                `;
                return false;
            }
            return true;
        }
        
        // 2. æ£€æŸ¥ Apple Pay æ”¯æŒ
        async function checkApplePaySupport() {
            if (!window.PaymentRequest) {
                statusDiv.innerHTML = '<p style="color:red">âŒ æµè§ˆå™¨ä¸æ”¯æŒ Payment Request API</p>';
                return false;
            }
            
            try {
                // åˆ›å»º Apple Pay æ”¯ä»˜æ–¹å¼
                const applePayMethod = {
                    supportedMethods: "https://apple.com/apple-pay",
                    data: {
                        version: 3,
                        merchantIdentifier: "merchant.com.apple.test", // æµ‹è¯•ç”¨
                        merchantCapabilities: ["supports3DS"],
                        supportedNetworks: ["visa", "mastercard", "amex"],
                        countryCode: "US"
                    }
                };
                
                const paymentRequest = new PaymentRequest(
                    [applePayMethod],
                    {
                        total: {
                            label: "æµ‹è¯•å•†å“",
                            amount: { currency: "USD", value: "1.00" }
                        }
                    }
                );
                
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒ
                const canMakePayment = await paymentRequest.canMakePayment();
                
                if (canMakePayment) {
                    applePayBtn.style.display = 'block';
                    statusDiv.innerHTML = '<p style="color:green">âœ… æ”¯æŒ Apple Pay</p>';
                    return true;
                } else {
                    statusDiv.innerHTML = '<p style="color:orange">âš ï¸ ä¸æ”¯æŒ Apple Pay</p>';
                    return false;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<p style="color:red">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
                return false;
            }
        }
        
        // 3. åˆå§‹åŒ–
        async function initialize() {
            if (!checkEnvironment()) return;
            
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥ Apple Pay æ”¯æŒ...</p>';
            const supported = await checkApplePaySupport();
            
            if (supported) {
                applePayBtn.onclick = processApplePay;
            }
        }
        
        // 4. å¤„ç† Apple Pay æ”¯ä»˜
        async function processApplePay() {
            resultDiv.innerHTML = '<p>æ­£åœ¨å¯åŠ¨ Apple Pay...</p>';
            
            try {
                const applePayMethod = {
                    supportedMethods: "https://apple.com/apple-pay",
                    data: {
                        version: 3,
                        merchantIdentifier: "merchant.com.example.test",
                        merchantCapabilities: ["supports3DS", "supportsCredit", "supportsDebit"],
                        supportedNetworks: ["visa", "mastercard", "amex", "discover"],
                        countryCode: "US"
                    }
                };
                
                const paymentDetails = {
                    total: {
                        label: "æˆ‘çš„å•†åº—",
                        amount: { currency: "USD", value: "19.99" }
                    },
                    displayItems: [
                        {
                            label: "å•†å“ä»·æ ¼",
                            amount: { currency: "USD", value: "17.99" }
                        },
                        {
                            label: "è¿è´¹",
                            amount: { currency: "USD", value: "2.00" }
                        }
                    ]
                };
                
                const paymentRequest = new PaymentRequest(
                    [applePayMethod],
                    paymentDetails,
                    {
                        requestPayerName: true,
                        requestPayerEmail: true,
                        requestPayerPhone: false,
                        requestShipping: false
                    }
                );
                
                // æ˜¾ç¤º Apple Pay ç•Œé¢
                const paymentResponse = await paymentRequest.show();
                
                // è¿™é‡Œåº”è¯¥å‘é€åˆ°ä½ çš„æœåŠ¡å™¨éªŒè¯
                resultDiv.innerHTML = '<p>æ­£åœ¨éªŒè¯æ”¯ä»˜...</p>';
                
                // æ¨¡æ‹ŸæœåŠ¡å™¨éªŒè¯
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // å®Œæˆæ”¯ä»˜
                await paymentResponse.complete('success');
                
                resultDiv.innerHTML = `
                    <div style="background:#d4edda; padding:20px; border:1px solid #c3e6cb;">
                        <h3 style="color:#155724">âœ… æ”¯ä»˜æˆåŠŸï¼</h3>
                        <p>é‡‘é¢ï¼š$19.99 USD</p>
                        <p>æ–¹å¼ï¼šApple Pay</p>
                        <p>æ—¶é—´ï¼š${new Date().toLocaleString()}</p>
                    </div>
                `;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    resultDiv.innerHTML = '<p style="color:blue">ç”¨æˆ·å–æ¶ˆäº†æ”¯ä»˜</p>';
                } else {
                    resultDiv.innerHTML = `<p style="color:red">âŒ æ”¯ä»˜å¤±è´¥: ${error.message}</p>`;
                    console.error('Apple Pay é”™è¯¯:', error);
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
